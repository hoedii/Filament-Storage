<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Filament Storage</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/hoedii/Filament-Storage/main/Logo%20Filamentlager.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #0057b8;
      --accent: #f0f4f9;
      --text: #222;
      --border: #ddd;
      --bg: #fff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 40px;
      background: var(--accent);
      color: var(--text);
    }

    h2 {
      margin-top: 0;
    }

    .card {
      background: var(--bg);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      position: relative;
    }

    th {
      background-color: #f8f9fa;
    }

    tr:hover td {
      background-color: #f1f5fa;
    }

    .checkbox {
      text-align: center;
    }

    .numeric {
      text-align: right;
    }

    .summary-row {
      font-weight: bold;
      background: #f9f9f9;
    }

    .summary-row td {
      border: none;
    }

    .summary-label {
      text-align: right;
      padding-right: 10px;
    }

    .filter-toggle {
      vertical-align: middle;
      color: #4a90e2 !important;
      top: 2px;
      position: relative;
      font-size: 14px;
      padding: 0 2px;
    }

    .filter-popup {
      position: absolute;
      top: 100%;
      left: 0;
      transform: none;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 24px 32px 20px 32px;
      z-index: 9999;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      display: none;
      min-width: unset;
      max-width: 90vw;
      max-height: 80vh;
      overflow: auto;
    }

    .filter-popup label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }

    .filter-popup select,
    .filter-popup input[type=range] {
      width: 100%;
      margin-bottom: 8px;
    }

    .filter-popup .range-values {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }

    .filter-toggle.active {
      background: #e0eaff !important;
      color: #0057b8 !important;
      border-radius: 4px;
    }

    .filter-popup {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      border: 1.5px solid #b3c6e0;
      background: #fafdff;
      padding: 16px 14px 12px 14px;
      border-radius: 10px;
      min-width: 180px;
      margin-top: 6px;
    }

    .filter-popup label {
      font-size: 14px;
      color: #0057b8;
      margin-bottom: 8px;
      display: block;
    }

    .filter-popup select, .filter-popup input[type=range] {
      margin-bottom: 12px;
      margin-top: 2px;
    }

    .filter-popup .range-values {
      margin-bottom: 6px;
    }

    .filter-toggle.active-dropdown {
      background: #e6fbe6 !important;
      color: #1a7f37 !important;
      border-radius: 4px;
    }

    .filter-toggle.active-range {
      background: #fff4e0 !important;
      color: #b86a00 !important;
      border-radius: 4px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .loader-dots {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 48px;
      min-width: 70px;
      gap: 10px;
    }
    .loader-dots span {
      display: block;
      width: 14px;
      height: 14px;
      background: #0057b8;
      border-radius: 50%;
      opacity: 0.7;
      animation: loader-dots-bounce 1.2s infinite both;
    }
    .loader-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .loader-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes loader-dots-bounce {
      0%, 80%, 100% { transform: scale(0.7); opacity: 0.7; }
      40% { transform: scale(1.2); opacity: 1; }
    }

    /* Custom blue checkboxes for popups (material selection) */
    #printRows input[type="checkbox"], #createLinkRows input[type="checkbox"] {
      accent-color: var(--primary);
    }
  </style>
</head>
<body>
  <div id="loader" style="position:fixed;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);z-index:3000;display:none;">
    <div class="loader-dots">
      <span></span><span></span><span></span>
    </div>
    <span id="loaderText" style="margin-left:24px;font-size:1.2rem;color:#0057b8;font-weight:bold;">Loading data from Google Sheets</span>
  </div>
  <div id="dataUpdatePopup" style="display:none;position:fixed;top:24px;left:50%;transform:translateX(-50%);background:#0057b8;color:#fff;padding:12px 32px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.12);font-size:1.1rem;z-index:5000;font-weight:bold;transition:opacity 0.3s;opacity:0;">Data updated</div>
  <!-- Link-Manager Modal -->
  <div id="linkManagerModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:5000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:32px 28px 24px 28px;border-radius:14px;box-shadow:0 2px 16px rgba(0,0,0,0.15);display:flex;flex-direction:column;gap:18px;min-width:340px;max-width:600px;max-height:90vh;overflow:auto;">
      <h3 style="margin:0 0 8px 0;">Shared Filter Links</h3>
      <div id="linkList"></div>
      <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:10px;">
        <button id="createLinkBtn" style="padding:7px 18px;border-radius:6px;border:none;background:#0057b8;color:#fff;font-weight:bold;cursor:pointer;">Create new link</button>
        <button id="closeLinkManager" style="padding:7px 18px;border-radius:6px;border:none;background:#eee;color:#333;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>
  <!-- Modal für Link-Erstellung (wird per JS befüllt) -->
  <div id="createLinkModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:6000;align-items:center;justify-content:center;">
    <form id="createLinkForm" style="background:#fff;padding:32px 28px 24px 28px;border-radius:14px;box-shadow:0 2px 16px rgba(0,0,0,0.15);display:flex;flex-direction:column;gap:18px;min-width:520px;max-width:1100px;max-height:90vh;overflow:auto;">
      <h3 style="margin:0 0 8px 0;">Which positions should be visible in the link?</h3>
      <div id="createLinkRows" style="display:flex;flex-direction:column;gap:6px;max-height:45vh;overflow:auto;"></div>
      <div style="margin-top:16px;display:flex;flex-direction:column;gap:8px;align-items:flex-start;">
        <label style="font-weight:bold;">Name for the link: <input type="text" id="createLinkName" style="margin-left:8px;padding:4px 8px;border-radius:5px;border:1px solid #ccc;" placeholder="My filter link" required></label>
      </div>
      <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:10px;">
        <button type="button" id="createLinkCancel" style="padding:7px 18px;border-radius:6px;border:none;background:#eee;color:#333;cursor:pointer;">Cancel</button>
        <button type="submit" style="padding:7px 18px;border-radius:6px;border:none;background:#0057b8;color:#fff;font-weight:bold;cursor:pointer;">Create link</button>
      </div>
    </form>
  </div>
  <div class="card">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <h2 style="margin: 0;">Filament Storage</h2>
      <div style="display:flex;gap:10px;align-items:center;">
        <button id="printBtn" title="Export Table as PDF" style="padding:5px 14px;border-radius:6px;border:none;background:#0057b8;color:#fff;font-weight:bold;cursor:pointer;font-size:14px;">
          Export Table
        </button>
        <button id="linkManagerBtn" title="Filter-Links verwalten" style="padding:5px 14px;border-radius:6px;border:none;background:#0057b8;color:#fff;font-weight:bold;cursor:pointer;font-size:14px;display:inline-flex;align-items:center;gap:6px;">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;"><path d="M4 10.5V6.5C4 5.11929 5.11929 4 6.5 4H13.5C14.8807 4 16 5.11929 16 6.5V13.5C16 14.8807 14.8807 16 13.5 16H9.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 16L6 16C5.44772 16 5 15.5523 5 15L5 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Links
        </button>
      </div>
    </div>
    <table id="spoolTable">
      <thead id="tableHead"></thead>
      <tbody></tbody>
      <tfoot></tfoot>
    </table>
  </div>
  <!-- Modal für Zeilenauswahl -->
  <div id="printModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:4000;align-items:center;justify-content:center;">
    <form id="printForm" style="background:#fff;padding:32px 28px 24px 28px;border-radius:14px;box-shadow:0 2px 16px rgba(0,0,0,0.15);display:flex;flex-direction:column;gap:18px;min-width:520px;max-width:1100px;max-height:90vh;overflow:auto;">
      <h3 style="margin:0 0 8px 0;">Which positions to export?</h3>
      <div id="printRows" style="display:flex;flex-direction:column;gap:6px;max-height:45vh;overflow:auto;"></div>
      <div style="margin-top:16px;display:flex;flex-direction:column;gap:8px;align-items:flex-start;">
        <label><input type="checkbox" id="pdfTotalFilament" checked> Show total filament</label>
        <label><input type="checkbox" id="pdfTotalResin" checked> Show total resin</label>
        <label><input type="checkbox" id="pdfTotalAll" checked> Show total</label>
      </div>
      <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:10px;">
        <button type="button" id="printCancel" style="padding:7px 18px;border-radius:6px;border:none;background:#eee;color:#333;cursor:pointer;">Cancel</button>
        <button type="submit" style="padding:7px 18px;border-radius:6px;border:none;background:#0057b8;color:#fff;font-weight:bold;cursor:pointer;">Create PDF</button>
      </div>
    </form>
  </div>

  <footer style="text-align: center; margin-top: 40px;">
    <span style="font-size: 12px; color: #888;">
      © 2025 piodeer. All rights reserved. Created with
      <a href="https://github.com/hoedii/Filament-Storage" style="color: inherit; text-decoration: none;" target="_blank">Github</a>, Cursor & ChatGPT.
    </span>
  </footer>

  <script>
    const sheetUrl = 'https://script.google.com/macros/s/AKfycbzG35aQBQU_gCfj5Fzbk5n707CROTdHj7N132aIpbkx-HdmTI1PmOnW3T-YEvGyKOsfVQ/exec';
    let originalData = [];
    let filters = {};
    let rangeFilters = {};
    let sortState = { key: null, asc: true };
    let lockedFilters = null;

    const colorNameMap = {
      'Dark Blue': '#2d3d5c',
      'Olive Green': '#5b6037',
      'Turqoise': '#009cbd',
      'Sakura Pink': '#f5c7d6',
      'Purple': '#7f74a7',
      'Green-Brown': '#60643f',
      'Plum': '#942e54',
      'Brown': '#9b8472',
    };

    function getUrlParams() {
      const params = {};
      window.location.search.substring(1).split('&').forEach(pair => {
        if (!pair) return;
        const [key, value] = pair.split('=');
        params[decodeURIComponent(key)] = decodeURIComponent(value || '');
      });
      return params;
    }

    function applyUrlFiltersAndLock() {
      const params = getUrlParams();
      lockedFilters = {};
      for (const key in params) {
        const colKey = Object.keys(originalData[0] || {}).find(k => k.toLowerCase() === key.toLowerCase());
        if (colKey) {
          const values = params[key].split(',');
          filters[colKey] = values.length > 1 ? values : values[0];
          lockedFilters[colKey] = filters[colKey];
        }
      }
      if (Object.keys(lockedFilters).length > 0) {
        applyFilters();
        // Link-Manager ausblenden, wenn Locked Mode aktiv
        const linkManagerBtn = document.getElementById('linkManagerBtn');
        const linkManagerModal = document.getElementById('linkManagerModal');
        if (linkManagerBtn) linkManagerBtn.style.display = 'none';
        if (linkManagerModal) linkManagerModal.style.display = 'none';
        // Export Table Button ausblenden
        const printBtn = document.getElementById('printBtn');
        if (printBtn) printBtn.style.display = 'none';
      } else {
        lockedFilters = null;
        // Link-Manager wieder einblenden, wenn kein Locked Mode
        const linkManagerBtn = document.getElementById('linkManagerBtn');
        const linkManagerModal = document.getElementById('linkManagerModal');
        if (linkManagerBtn) linkManagerBtn.style.display = '';
        if (linkManagerModal) linkManagerModal.style.display = '';
        // Export Table Button wieder einblenden
        const printBtn = document.getElementById('printBtn');
        if (printBtn) printBtn.style.display = '';
      }
    }

    function getSavedLinks() {
      return JSON.parse(localStorage.getItem('filterLinks') || '[]');
    }
    function saveLinks(links) {
      localStorage.setItem('filterLinks', JSON.stringify(links));
    }
    function renderLinkList() {
      const links = getSavedLinks();
      const listDiv = document.getElementById('linkList');
      if (!listDiv) return;
      listDiv.innerHTML = '';
      if (links.length === 0) {
        listDiv.innerHTML = '<div style="color:#888;font-size:15px;">No links saved yet.</div>';
        return;
      }
      links.forEach((link, idx) => {
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.gap = '12px';
        div.style.marginBottom = '6px';
        div.innerHTML = `<a href="${link.url}" target="_blank" style="color:#0057b8;font-weight:bold;text-decoration:underline;">${link.name || link.url}</a>`;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.padding = '3px 10px';
        delBtn.style.borderRadius = '5px';
        delBtn.style.border = 'none';
        delBtn.style.background = '#eee';
        delBtn.style.color = '#333';
        delBtn.style.cursor = 'pointer';
        delBtn.onclick = () => {
          links.splice(idx, 1);
          saveLinks(links);
          renderLinkList();
        };
        div.appendChild(delBtn);
        listDiv.appendChild(div);
      });
    }
    // Link-Manager Modal öffnen/schließen
    document.getElementById('linkManagerBtn').onclick = function() {
      renderLinkList();
      document.getElementById('linkManagerModal').style.display = 'flex';
    };
    document.getElementById('closeLinkManager').onclick = function() {
      document.getElementById('linkManagerModal').style.display = 'none';
    };
    // Link-Manager Modal auch mit ESC schließen
    window.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modals = [
          document.getElementById('linkManagerModal'),
          document.getElementById('printModal'),
          document.getElementById('createLinkModal'),
          document.getElementById('filamentImageModal')
        ];
        modals.forEach(modal => {
          if (modal && (modal.style.display === 'flex' || modal.style.display === 'block')) {
            // For filamentImageModal, remove from DOM
            if (modal.id === 'filamentImageModal') {
              modal.remove();
            } else {
              modal.style.display = 'none';
            }
          }
        });
      }
    });
    // Link-Liste initial rendern
    renderLinkList();

    // Handler für 'Neuen Link erstellen' im Link-Manager-Modal
    function setupCreateLinkBtnHandler() {
      const createLinkBtn = document.getElementById('createLinkBtn');
      if (!createLinkBtn) return;
      createLinkBtn.onclick = function() {
        // Modal wie beim PDF-Export anzeigen
        const modal = document.getElementById('createLinkModal');
        const rowsDiv = document.getElementById('createLinkRows');
        rowsDiv.innerHTML = '';
        // Sichtbare Spool IDs aus der aktuellen Tabelle
        const tableBody = document.querySelector('#spoolTable tbody');
        const visibleSpoolIds = new Set();
        Array.from(tableBody.querySelectorAll('tr')).forEach(tr => {
          const cells = tr.querySelectorAll('td');
          if (cells.length >= 4) {
            visibleSpoolIds.add(cells[3].textContent.trim());
          }
        });
        // Zeilen holen: IMMER alle Zeilen mit Spool ID anzeigen
        const filtered = originalData.filter(row => row['Spool ID'] && row['Spool ID'].trim() !== '');
        filtered.forEach((row, idx) => {
          const label = document.createElement('label');
          label.style.display = 'flex';
          label.style.alignItems = 'center';
          label.style.gap = '12px';
          // Bildvorschau
          const material = (row['Material'] || '').replace(/ /g, '%20');
          const hersteller = (row['Hersteller'] || row['Manufacturer'] || '').replace(/ /g, '%20');
          const farbe = (row['Farbe'] || row['Color'] || '').replace(/ /g, '%20');
          const imgUrl = `https://raw.githubusercontent.com/hoedii/Filament-Storage/main/ressourcen/${material}_${hersteller}_${farbe}.jpg`;
          const img = document.createElement('img');
          img.src = imgUrl;
          img.alt = 'Filament';
          img.style.width = '38px';
          img.style.height = '38px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '7px';
          img.style.background = '#f6f6f6';
          img.style.border = '1px solid #ddd';
          img.onerror = () => { img.style.display = 'none'; };
          label.appendChild(img);
          // Checkbox
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          // Haken nur, wenn Spool ID in der Tabelle sichtbar ist
          cb.checked = visibleSpoolIds.has((row['Spool ID'] || '').trim());
          cb.value = idx;
          cb.onclick = (e) => e.stopPropagation();
          label.appendChild(cb);
          // Zeilen-Text (z.B. Spool ID + Material + Farbe)
          let txt = row['Spool ID'] || '';
          if (row['Material']) txt += ' | ' + row['Material'];
          if (row['Farbe'] || row['Color']) txt += ' | ' + (row['Farbe'] || row['Color']);
          label.appendChild(document.createTextNode(txt));
          rowsDiv.appendChild(label);
        });
        // Name-Feld
        document.getElementById('createLinkName').value = '';
        modal.style.display = 'flex';
        // Cancel-Button
        document.getElementById('createLinkCancel').onclick = function() {
          modal.style.display = 'none';
        };
        // Submit-Handler
        document.getElementById('createLinkForm').onsubmit = async function(e) {
          e.preventDefault();
          const checkboxes = Array.from(document.querySelectorAll('#createLinkRows input[type=checkbox]'));
          const selectedIdx = checkboxes.filter(cb => cb.checked).map(cb => parseInt(cb.value));
          if (selectedIdx.length === 0) {
            alert('Please select at least one position!');
            return;
          }
          // Zeilen für Link: gleiche Reihenfolge wie im Modal (alle mit Spool ID)
          const filteredRows = originalData.filter(row => row['Spool ID'] && row['Spool ID'].trim() !== '');
          const selectedSpoolIds = selectedIdx.map(i => filteredRows[i]['Spool ID']);
          const params = [];
          if (selectedSpoolIds.length > 0) {
            params.push(encodeURIComponent('Spool ID') + '=' + encodeURIComponent(selectedSpoolIds.join(',')));
          }
          const url = window.location.origin + window.location.pathname + (params.length ? '?' + params.join('&') : '');
          const name = document.getElementById('createLinkName').value.trim() || url;
          let shortUrl = url;
          try {
            const resp = await fetch('https://is.gd/create.php?format=simple&url=' + encodeURIComponent(url));
            const txt = await resp.text();
            if (resp.ok && txt.startsWith('http')) {
              shortUrl = txt;
            }
          } catch (e) {}
          // Speichern
          if (name) {
            const links = getSavedLinks();
            links.push({ name, url: shortUrl });
            saveLinks(links);
            renderLinkList();
          }
          modal.style.display = 'none';
        };
      };
    }
    // Nach dem initialen Rendern und nach jedem Daten-Reload Handler setzen
    document.addEventListener('DOMContentLoaded', setupCreateLinkBtnHandler);
    // Auch nach jedem Daten-Reload sicherstellen
    function afterDataReload() {
      setupCreateLinkBtnHandler();
    }

    function renderTable(data) {
      const tableHead = document.getElementById('tableHead');
      const tbody = document.querySelector('#spoolTable tbody');
      tableHead.innerHTML = '';
      tbody.innerHTML = '';

      // Kopfzeile immer anzeigen, auch wenn keine Daten
      const keys = Object.keys(originalData[0] || {});
      const headRow = document.createElement('tr');
      keys.forEach(k => {
        const th = document.createElement('th');
        th.style.position = 'relative';
        th.textContent = k;
        // Sortier-Button
        const sortBtn = document.createElement('button');
        sortBtn.textContent = sortState.key === k ? (sortState.asc ? '▲' : '▼') : '↕';
        sortBtn.style.marginLeft = '6px';
        sortBtn.style.fontSize = '12px';
        sortBtn.style.background = 'none';
        sortBtn.style.border = 'none';
        sortBtn.style.cursor = 'pointer';
        sortBtn.title = 'Sortieren';
        sortBtn.onclick = () => {
          if (sortState.key === k) {
            sortState.asc = !sortState.asc;
          } else {
            sortState.key = k;
            sortState.asc = true;
          }
          applyFilters();
        };
        th.appendChild(sortBtn);
        // Filter-Button NUR wenn nicht lockedFilters aktiv und nicht Measured (g) oder Remaining (g)
        if (!lockedFilters && k !== 'Measured (g)' && k !== 'Remaining (g)') {
          const chevronDownSVG = `<svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline;vertical-align:middle;"><path d="M6 8L10 12L14 8" stroke="#4a90e2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          const filterIcon = document.createElement('span');
          filterIcon.className = 'filter-toggle';
          filterIcon.innerHTML = chevronDownSVG;
          filterIcon.style.cursor = 'pointer';
          filterIcon.style.marginLeft = '6px';
          filterIcon.style.display = 'inline-flex';
          filterIcon.style.alignItems = 'center';
          filterIcon.style.background = 'none';
          filterIcon.style.border = 'none';
          filterIcon.style.outline = 'none';
          filterIcon.style.padding = '0';
          if (isColumnFilterActive(k)) {
            const type = getColumnFilterType(k);
            if (type === 'range') filterIcon.classList.add('active-range');
            else filterIcon.classList.add('active-dropdown');
          }
          const popup = document.createElement('div');
          popup.className = 'filter-popup';
          popup.dataset.key = k;
          filterIcon.appendChild(popup);
          filterIcon.onclick = (e) => toggleFilterPopup(e, k, originalData, true);
          th.appendChild(filterIcon);
        }
        headRow.appendChild(th);
      });
      tableHead.appendChild(headRow);

      // Nur Zeilen rendern, wenn Daten vorhanden
      if (data.length) {
        // Sortierung anwenden
        let sortedData = [...data];
        if (sortState.key) {
          sortedData.sort((a, b) => {
            const valA = a[sortState.key] || '';
            const valB = b[sortState.key] || '';
            // Zahlenvergleich, falls beide Werte Zahlen sind
            if (!isNaN(valA) && !isNaN(valB) && valA !== '' && valB !== '') {
              return sortState.asc ? (parseFloat(valA) - parseFloat(valB)) : (parseFloat(valB) - parseFloat(valA));
            }
            // Stringvergleich
            return sortState.asc ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
          });
        }

        // Zeilen ohne Spool ID ausblenden
        sortedData = sortedData.filter(row => row['Spool ID'] && row['Spool ID'].trim() !== '');

        // Immer alle Zeilen anzeigen
        let rowsToShow = sortedData;

        rowsToShow.forEach(row => {
          const tr = document.createElement('tr');
          keys.forEach(key => {
            const td = document.createElement('td');
            if (row[key] === 'x') {
              td.classList.add('checkbox');
              td.innerHTML = '✔️';
            } else if (!isNaN(row[key]) && row[key] !== '') {
              td.classList.add('numeric');
              // Spezialfall: Remaining (g) farbiges Kästchen
              if (key === 'Remaining (g)') {
                const val = parseFloat(row[key]);
                const box = document.createElement('span');
                box.textContent = val.toFixed(1) + ' g';
                box.style.display = 'inline-block';
                box.style.minWidth = '64px';
                box.style.textAlign = 'center';
                box.style.padding = '4px 10px';
                box.style.borderRadius = '7px';
                box.style.fontWeight = 'bold';
                if (val === 0) {
                  box.style.background = 'none';
                  box.style.color = '#888';
                } else if (val >= 1000) {
                  box.style.background = '#e0e0e0';
                  box.style.color = '#333';
                } else {
                  // Farbverlauf: 1000g = grün, 500g = gelb, 0g = rot
                  // Interpolieren zwischen grün (#4caf50), gelb (#ffeb3b), rot (#f44336)
                  let color;
                  if (val > 500) {
                    // Grün zu Gelb
                    const t = (val - 500) / 500; // 1 bei 1000, 0 bei 500
                    color = interpolateColor('#ffeb3b', '#4caf50', t);
                  } else {
                    // Gelb zu Rot
                    const t = val / 500; // 1 bei 500, 0 bei 0
                    color = interpolateColor('#f44336', '#ffeb3b', t);
                  }
                  box.style.background = color;
                  box.style.color = '#222';
                }
                td.appendChild(box);
              } else {
                td.textContent = parseFloat(row[key]).toFixed(1) + ' g';
              }
            } else if (key === 'Farbe' || key === 'Color') {
              const wrapper = document.createElement('div');
              wrapper.style.display = 'flex';
              wrapper.style.alignItems = 'flex-start';
              wrapper.style.justifyContent = 'flex-start';
              // Farbfeld
              const colorValue = row[key] || '';
              const colorBox = document.createElement('span');
              colorBox.style.display = 'inline-block';
              colorBox.style.width = '22px';
              colorBox.style.height = '22px';
              colorBox.style.marginRight = '10px';
              colorBox.style.borderRadius = '6px';
              colorBox.style.border = '1.5px solid #bbb';
              colorBox.style.boxSizing = 'border-box';
              let cssColor = getCssColor(colorValue);
              colorBox.style.background = cssColor;
              wrapper.appendChild(colorBox);
              // Namen und Info-Icon nebeneinander
              const nameInfoRow = document.createElement('div');
              nameInfoRow.style.display = 'flex';
              nameInfoRow.style.flexDirection = 'row';
              nameInfoRow.style.alignItems = 'center';
              nameInfoRow.style.gap = '6px';
              // Farbnamen
              const colorDiv = document.createElement('div');
              colorDiv.textContent = row[key] || '';
              nameInfoRow.appendChild(colorDiv);
              // Info-Icon ggf. rechts daneben
              (async () => {
                const material = (row['Material'] || '').replace(/ /g, '%20');
                const hersteller = (row['Hersteller'] || row['Manufacturer'] || '').replace(/ /g, '%20');
                const farbe = (row['Farbe'] || row['Color'] || '').replace(/ /g, '%20');
                const imgUrl = `https://raw.githubusercontent.com/hoedii/Filament-Storage/main/ressourcen/${material}_${hersteller}_${farbe}.jpg`;
                const settingsUrl = `https://raw.githubusercontent.com/hoedii/Filament-Storage/main/ressourcen/${material}_${hersteller}.json`;
                let hasImage = false, hasSettings = false;
                try {
                  const imgRes = await fetch(imgUrl, { method: 'HEAD' });
                  hasImage = imgRes.ok;
                } catch {}
                try {
                  const setRes = await fetch(settingsUrl, { method: 'HEAD' });
                  hasSettings = setRes.ok;
                } catch {}
                if (hasImage || hasSettings) {
                  const infoBtn = document.createElement('span');
                  infoBtn.textContent = 'i';
                  infoBtn.style.display = 'inline-flex';
                  infoBtn.style.alignItems = 'center';
                  infoBtn.style.justifyContent = 'center';
                  infoBtn.style.width = '18px';
                  infoBtn.style.height = '18px';
                  infoBtn.style.fontSize = '13px';
                  infoBtn.style.background = '#eee';
                  infoBtn.style.color = '#888';
                  infoBtn.style.borderRadius = '50%';
                  infoBtn.style.cursor = 'pointer';
                  infoBtn.style.border = 'none';
                  infoBtn.style.userSelect = 'none';
                  infoBtn.title = 'Filamentbild/Einstellungen anzeigen';
                  infoBtn.onclick = (e) => {
                    e.stopPropagation();
                    showFilamentImage(row);
                  };
                  nameInfoRow.appendChild(infoBtn);
                }
              })();
              wrapper.appendChild(nameInfoRow);
              td.appendChild(wrapper);
            } else {
              td.textContent = row[key] || '';
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }
    }

    function toggleFilterPopup(e, key, data, userClick = false, forceOpen = false) {
      if (lockedFilters) return; // Keine Filteränderung im Locked Mode
      const filterIcon = e.target.closest('.filter-toggle');
      const popup = filterIcon.querySelector('.filter-popup');
      const isOpen = popup.style.display === 'block';
      popup.innerHTML = '';
      popup.style.display = 'block';
      popup.style.position = 'absolute';
      popup.style.left = '0';
      popup.style.top = '100%';
      popup.style.zIndex = 9999;
      // Nach dem Anzeigen: Position ggf. anpassen, damit Popup immer sichtbar bleibt
      setTimeout(() => {
        const popupRect = popup.getBoundingClientRect();
        const btnRect = filterIcon.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        // Wenn unten abgeschnitten, nach oben anzeigen
        if (popupRect.bottom > viewportHeight && popupRect.height < btnRect.top) {
          popup.style.top = 'auto';
          popup.style.bottom = '100%';
        } else {
          popup.style.top = '100%';
          popup.style.bottom = 'auto';
        }
        // Wenn rechts abgeschnitten, nach links verschieben
        if (popupRect.right > viewportWidth) {
          const overflow = popupRect.right - viewportWidth + 8;
          popup.style.left = `-${overflow}px`;
        } else {
          popup.style.left = '0';
        }
        // Card-Container und Tabelle so hoch machen, dass Popup immer Platz hat
        const card = document.querySelector('.card');
        const table = document.getElementById('spoolTable');
        if (card) {
          const cardRect = card.getBoundingClientRect();
          const popupBottom = popupRect.top + popupRect.height;
          const cardBottom = cardRect.top + cardRect.height;
          if (popupBottom > cardBottom) {
            const diff = popupBottom - cardRect.top + 24; // etwas Puffer
            card.style.minHeight = diff + 'px';
            if (table) table.style.minHeight = (diff - (cardRect.height - table.offsetHeight)) + 'px';
          }
        }
      }, 0);

      // Stoppe Event-Propagation im Popup, damit Klicks im Popup nicht "nach oben" wandern
      popup.addEventListener('mousedown', function(e) { e.stopPropagation(); });

      // Temporäre Filterwerte
      let tempFilter = filters[key] || '';
      let tempRange = rangeFilters[key] ? {
        min: rangeFilters[key].min.value,
        max: rangeFilters[key].max.value
      } : null;

      // Funktion zum Übernehmen und Anwenden der Filter
      function applyTempFilterAndClose() {
        // Filter erst jetzt übernehmen
        if (getColumnFilterType(key) === 'range') {
          if (!rangeFilters[key]) rangeFilters[key] = {};
          rangeFilters[key].min.value = tempRange.min;
          rangeFilters[key].max.value = tempRange.max;
        } else {
          filters[key] = tempFilter;
        }
        applyFilters();
        popup.style.display = 'none';
        resetCardMinHeight();
      }

      // Schließen-Button oben rechts
      const closeBtn = document.createElement('span');
      closeBtn.textContent = '×';
      closeBtn.style.position = 'absolute';
      closeBtn.style.top = '8px';
      closeBtn.style.right = '12px';
      closeBtn.style.cursor = 'pointer';
      closeBtn.style.fontSize = '18px';
      closeBtn.style.color = '#888';
      closeBtn.title = 'Anwenden & Schließen';
      closeBtn.onclick = (ev) => {
        ev.stopPropagation();
        applyTempFilterAndClose();
      };
      popup.appendChild(closeBtn);

      if (key === 'Measured (g)' || key === 'Remaining (g)') {
        const values = data.map(row => parseFloat(row[key])).filter(v => !isNaN(v));
        const minVal = Math.min(...values);
        const maxVal = Math.max(...values);
        const label = document.createElement('label');
        label.textContent = key;
        popup.appendChild(label);

        // Double Range Slider Wrapper
        const sliderWrapper = document.createElement('div');
        sliderWrapper.style.position = 'relative';
        sliderWrapper.style.height = '40px';
        sliderWrapper.style.margin = '18px 0 8px 0';
        sliderWrapper.style.display = 'flex';
        sliderWrapper.style.alignItems = 'center';

        // Farbbalken für den Bereich zwischen min und max
        const rangeBar = document.createElement('div');
        rangeBar.style.position = 'absolute';
        rangeBar.style.height = '6px';
        rangeBar.style.background = '#4a90e2';
        rangeBar.style.borderRadius = '3px';
        rangeBar.style.top = '50%';
        rangeBar.style.transform = 'translateY(-50%)';
        rangeBar.style.zIndex = '0';
        rangeBar.style.pointerEvents = 'none';
        sliderWrapper.appendChild(rangeBar);

        // Min Range Input
        const minInput = document.createElement('input');
        minInput.type = 'range';
        minInput.min = minVal;
        minInput.max = maxVal;
        minInput.step = 1;
        minInput.value = tempRange ? tempRange.min : minVal;
        minInput.style.position = 'absolute';
        minInput.style.left = '0';
        minInput.style.top = '0';
        minInput.style.width = '100%';
        minInput.style.pointerEvents = 'auto';
        minInput.style.zIndex = '2';
        minInput.style.background = 'transparent';
        // Max Range Input
        const maxInput = document.createElement('input');
        maxInput.type = 'range';
        maxInput.min = minVal;
        maxInput.max = maxVal;
        maxInput.step = 1;
        maxInput.value = tempRange ? tempRange.max : maxVal;
        maxInput.style.position = 'absolute';
        maxInput.style.left = '0';
        maxInput.style.top = '0';
        maxInput.style.width = '100%';
        maxInput.style.pointerEvents = 'auto';
        maxInput.style.zIndex = '1';
        maxInput.style.background = 'transparent';

        // Werteanzeige
        const rangeDisplay = document.createElement('div');
        rangeDisplay.className = 'range-values';
        rangeDisplay.style.marginBottom = '6px';
        const minSpan = document.createElement('span');
        const maxSpan = document.createElement('span');
        minSpan.textContent = minInput.value + ' g';
        maxSpan.textContent = maxInput.value + ' g';
        rangeDisplay.appendChild(minSpan);
        rangeDisplay.appendChild(maxSpan);
        popup.appendChild(rangeDisplay);

        // Hilfsfunktion: Prozentwert für Balken berechnen
        function getPercent(val) {
          return ((val - minVal) / (maxVal - minVal)) * 100;
        }
        // Balken-Position aktualisieren
        function updateRangeBar() {
          const minP = getPercent(parseInt(minInput.value));
          const maxP = getPercent(parseInt(maxInput.value));
          rangeBar.style.left = minP + '%';
          rangeBar.style.width = (maxP - minP) + '%';
        }

        // Event-Handler für gegenseitige Begrenzung
        minInput.oninput = () => {
          if (parseInt(minInput.value) > parseInt(maxInput.value)) {
            minInput.value = maxInput.value;
          }
          minSpan.textContent = minInput.value + ' g';
          tempRange.min = minInput.value;
          updateRangeBar();
          // Filter sofort anwenden
          if (!rangeFilters[key]) rangeFilters[key] = {};
          rangeFilters[key].min.value = tempRange.min;
          rangeFilters[key].max.value = tempRange.max;
          applyFilters();
        };
        maxInput.oninput = () => {
          if (parseInt(maxInput.value) < parseInt(minInput.value)) {
            maxInput.value = minInput.value;
          }
          maxSpan.textContent = maxInput.value + ' g';
          tempRange.max = maxInput.value;
          updateRangeBar();
          // Filter sofort anwenden
          if (!rangeFilters[key]) rangeFilters[key] = {};
          rangeFilters[key].min.value = tempRange.min;
          rangeFilters[key].max.value = tempRange.max;
          applyFilters();
        };

        // Initiale Balken-Position
        updateRangeBar();

        sliderWrapper.appendChild(minInput);
        sliderWrapper.appendChild(maxInput);
        popup.appendChild(sliderWrapper);
      } else {
        const label = document.createElement('label');
        label.textContent = key;
        popup.appendChild(label);
        // Checkboxen für jede Option
        const optionsWrapper = document.createElement('div');
        optionsWrapper.style.display = 'flex';
        optionsWrapper.style.flexDirection = 'column';
        optionsWrapper.style.gap = '8px';
        optionsWrapper.style.whiteSpace = 'normal';
        const uniqueVals = [...new Set(originalData.map(row => row[key] || ''))].filter(v => v !== '').sort();
        // Alle-Checkbox
        const allCheckboxLabel = document.createElement('label');
        allCheckboxLabel.style.fontWeight = 'bold';
        const allCheckbox = document.createElement('input');
        allCheckbox.type = 'checkbox';
        allCheckbox.style.marginRight = '6px';
        allCheckbox.onclick = (e) => e.stopPropagation();
        allCheckboxLabel.appendChild(allCheckbox);
        allCheckboxLabel.appendChild(document.createTextNode('Alle'));
        optionsWrapper.appendChild(allCheckboxLabel);
        // Einzeloptionen
        const optionCheckboxes = [];
        uniqueVals.forEach(val => {
          const optLabel = document.createElement('label');
          optLabel.style.display = 'flex';
          optLabel.style.alignItems = 'center';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = val;
          cb.style.marginRight = '6px';
          cb.onclick = (e) => e.stopPropagation();
          optLabel.onclick = (e) => e.stopPropagation();
          optLabel.appendChild(cb);
          optLabel.appendChild(document.createTextNode(val));
          optionsWrapper.appendChild(optLabel);
          optionCheckboxes.push(cb);
        });
        // Vorbelegen
        if (Array.isArray(tempFilter)) {
          optionCheckboxes.forEach(cb => {
            cb.checked = tempFilter.includes(cb.value);
          });
        } else if (tempFilter) {
          optionCheckboxes.forEach(cb => {
            cb.checked = tempFilter === cb.value;
          });
        } else {
          // Standard: alle Haken
          optionCheckboxes.forEach(cb => { cb.checked = true; });
        }
        // Alle-Checkbox Status setzen
        const updateAllCheckbox = () => {
          const checkedCount = optionCheckboxes.filter(cb => cb.checked).length;
          if (checkedCount === optionCheckboxes.length) {
            allCheckbox.checked = true;
            allCheckbox.indeterminate = false;
          } else if (checkedCount === 0) {
            allCheckbox.checked = false;
            allCheckbox.indeterminate = false;
          } else {
            allCheckbox.checked = false;
            allCheckbox.indeterminate = true;
          }
        };
        updateAllCheckbox();
        // Checkboxen-Handler: nur tempFilter aktualisieren
        optionCheckboxes.forEach(cb => {
          cb.onchange = () => {
            updateAllCheckbox();
            const selected = optionCheckboxes.filter(c => c.checked).map(c => c.value);
            if (selected.length === 0) {
              tempFilter = [];
            } else if (selected.length === optionCheckboxes.length) {
              tempFilter = '';
            } else {
              tempFilter = selected;
            }
          };
        });
        // Alle-Checkbox-Handler: nur tempFilter aktualisieren
        allCheckbox.onchange = () => {
          const checked = allCheckbox.checked;
          optionCheckboxes.forEach(cb => { cb.checked = checked; });
          updateAllCheckbox();
          tempFilter = checked ? '' : [];
        };
        popup.appendChild(optionsWrapper);

        // Dynamische Breite: Passe die Popup-Breite an das längste Label an
        setTimeout(() => {
          let maxWidth = 0;
          popup.querySelectorAll('label').forEach(label => {
            // Temporär auf auto setzen, um echte Breite zu messen
            label.style.width = 'auto';
            const w = label.scrollWidth;
            if (w > maxWidth) maxWidth = w;
          });
          // 40px Padding addieren (links+rechts)
          popup.style.minWidth = (maxWidth + 40) + 'px';
        }, 0);

        // Filter beim Schließen (auch außerhalb-Klick) übernehmen
        popup._applyTempFilterAndClose = applyTempFilterAndClose;

        // Alle anderen offenen Popups schließen
        document.querySelectorAll('.filter-popup').forEach(p => { if (p !== e.target.closest('.filter-toggle').querySelector('.filter-popup')) p.style.display = 'none'; });
      }
    }

    function isFilterActive() {
      return Object.values(filters).some(f => f) ||
        Object.values(rangeFilters).some(f => f.min.value != f.min.min || f.max.value != f.max.max);
    }

    function applyFilters() {
      if (lockedFilters) {
        filters = { ...lockedFilters };
      }
      const data = originalData.filter(row => {
        for (let key in filters) {
          if (filters[key]) {
            if (Array.isArray(filters[key])) {
              if (filters[key].length === 0) return false;
              if (!filters[key].includes(row[key])) return false;
            } else {
              if (row[key] !== filters[key]) return false;
            }
          }
        }
        for (let key in rangeFilters) {
          const val = parseFloat(row[key]);
          if (isNaN(val)) return false;
          const min = parseFloat(rangeFilters[key].min.value);
          const max = parseFloat(rangeFilters[key].max.value);
          if (val < min || val > max) return false;
        }
        return true;
      });

      renderTable(data);
      renderSummary(data);
    }

    function renderSummary(data) {
      const tfoot = document.querySelector('#spoolTable tfoot');
      tfoot.innerHTML = '';

      let filament = 0, resin = 0;
      // Nur Zeilen mit Spool ID berücksichtigen (wie PDF)
      data.filter(row => row['Spool ID'] && row['Spool ID'].trim() !== '').forEach(row => {
        const mat = (row["Material"] || "").toLowerCase();
        const val = parseFloat(row["Remaining (g)"]);
        if (!isNaN(val)) {
          if (mat.includes("resin")) resin += val;
          else filament += val;
        }
      });

      const total = filament + resin;
      const rows = [
        ["Total Filament", filament],
        ["Total Resin", resin],
        ["Total", total]
      ];

      rows.forEach(([label, val]) => {
        const tr = document.createElement('tr');
        tr.className = 'summary-row';
        const tdLabel = document.createElement('td');
        tdLabel.colSpan = 9;
        tdLabel.className = 'summary-label';
        tdLabel.textContent = label;
        const tdValue = document.createElement('td');
        tdValue.className = 'numeric';
        tdValue.textContent = (val / 1000).toFixed(2) + ' kg';
        tr.appendChild(tdLabel);
        tr.appendChild(tdValue);
        tfoot.appendChild(tr);
      });
    }

    function showFilamentImage(row) {
      // Spool IDs mit gleichem Material, Hersteller, Farbe suchen
      const material = (row['Material'] || '').trim();
      const hersteller = (row['Hersteller'] || row['Manufacturer'] || '').trim();
      const farbe = (row['Farbe'] || row['Color'] || '').trim();
      const matchingSpoolIds = originalData
        .filter(r => (r['Material'] || '').trim() === material && (r['Hersteller'] || r['Manufacturer'] || '').trim() === hersteller && (r['Farbe'] || r['Color'] || '').trim() === farbe)
        .map(r => r['Spool ID'])
        .filter(Boolean);
      let spoolIdString = '';
      if (matchingSpoolIds.length > 0) {
        spoolIdString = ' (' + matchingSpoolIds.join(', ') + ')';
      }
      let modal = document.getElementById('filamentImageModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'filamentImageModal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.6)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '1000';
        modal.onclick = () => { modal.remove(); };
        document.body.appendChild(modal);
      } else {
        modal.innerHTML = '';
        modal.style.display = 'flex';
      }
      const materialEnc = material.replace(/ /g, '%20');
      const herstellerEnc = hersteller.replace(/ /g, '%20');
      const farbeEnc = farbe.replace(/ /g, '%20');
      const farbeText = farbe;
      const imgUrlDefault = `https://raw.githubusercontent.com/hoedii/Filament-Storage/main/ressourcen/${materialEnc}_${herstellerEnc}_${farbeEnc}.jpg`;
      const settingsUrl = `https://raw.githubusercontent.com/hoedii/Filament-Storage/main/ressourcen/${materialEnc}_${herstellerEnc}.json`;
      // Bild
      const img = document.createElement('img');
      img.src = imgUrlDefault;
      img.alt = `${material} ${hersteller} ${farbe}`;
      img.style.maxWidth = '340px';
      img.style.maxHeight = '320px';
      img.style.borderRadius = '10px';
      img.style.background = '#f6f6f6';
      img.style.objectFit = 'contain';
      img.style.boxShadow = '0 2px 12px rgba(0,0,0,0.07)';
      img.onerror = () => {
        img.style.display = 'none';
        errorMsg.style.display = 'block';
      };
      // Fehlermeldung Bild
      const errorMsg = document.createElement('div');
      errorMsg.textContent = 'No image found!';
      errorMsg.style.color = 'red';
      errorMsg.style.display = 'none';
      errorMsg.style.margin = '20px';
      errorMsg.style.fontWeight = 'bold';
      errorMsg.style.fontSize = '1.2rem';
      // Lade die JSON mit fetch
      fetch(settingsUrl)
        .then(res => {
          if (!res.ok) throw new Error('not found');
          return res.json();
        })
        .then(json => {
          // Modal-Inhalt Wrapper
          const inner = document.createElement('div');
          inner.style.background = '#fff';
          inner.style.padding = '32px 32px 28px 32px';
          inner.style.borderRadius = '16px';
          inner.style.maxWidth = '950px';
          inner.style.width = '95vw';
          inner.style.maxHeight = '92vh';
          inner.style.overflowY = 'auto';
          inner.style.display = 'flex';
          inner.style.flexDirection = 'column';
          inner.style.alignItems = 'stretch';
          inner.style.boxShadow = '0 6px 32px rgba(0,0,0,0.18)';
          inner.onclick = (e) => e.stopPropagation();
          // Titel
          const titleDiv = document.createElement('div');
          titleDiv.style.fontWeight = 'bold';
          titleDiv.style.fontSize = '2.1rem';
          titleDiv.style.marginBottom = '10px';
          titleDiv.style.display = 'flex';
          titleDiv.style.flexDirection = 'column';
          titleDiv.style.alignItems = 'flex-start';
          titleDiv.style.gap = '0';
          // Name + Farbe + Spool IDs
          let nameWithColor = '';
          if (json.name) {
            // Name fett und groß
            const nameDiv = document.createElement('div');
            nameDiv.style.fontWeight = 'bold';
            nameDiv.style.fontSize = '2.1rem';
            // Farbnamen
            let farbTextNode = document.createTextNode(json.name + (farbeText ? ' ' + farbeText : ''));
            nameDiv.appendChild(farbTextNode);
            // Spool IDs dezent
            if (spoolIdString) {
              const idSpan = document.createElement('span');
              idSpan.textContent = spoolIdString;
              idSpan.style.fontSize = '1.3rem';
              idSpan.style.color = '#888';
              idSpan.style.marginLeft = '10px';
              idSpan.style.fontWeight = 'normal';
              nameDiv.appendChild(idSpan);
            }
            // Hersteller klein darunter
            const herstellerDiv = document.createElement('div');
            herstellerDiv.style.fontSize = '1.1rem';
            herstellerDiv.style.color = '#888';
            herstellerDiv.style.fontWeight = 'normal';
            herstellerDiv.style.marginTop = '2px';
            herstellerDiv.textContent = (row['Hersteller'] || row['Manufacturer'] || '');
            titleDiv.textContent = '';
            titleDiv.appendChild(nameDiv);
            titleDiv.appendChild(herstellerDiv);
          }
          // Infos-Wrapper
          const infoCol = document.createElement('div');
          infoCol.style.display = 'flex';
          infoCol.style.flexDirection = 'column';
          infoCol.style.alignItems = 'flex-start';
          infoCol.style.justifyContent = 'flex-start';
          infoCol.style.width = 'min(100%, 700px)';
          infoCol.style.maxWidth = '700px';
          // Produktlink
          if (json.product_url) {
            const link = document.createElement('a');
            link.href = json.product_url;
            link.target = '_blank';
            link.style.display = 'inline-flex';
            link.style.alignItems = 'center';
            link.style.gap = '8px';
            link.style.background = '#0057b8';
            link.style.color = '#fff';
            link.style.fontWeight = 'bold';
            link.style.fontSize = '17px';
            link.style.padding = '10px 22px';
            link.style.borderRadius = '7px';
            link.style.textDecoration = 'none';
            link.style.marginBottom = '18px';
            link.style.marginTop = '6px';
            link.style.transition = 'background 0.2s';
            link.onmouseover = () => { link.style.background = '#003e87'; };
            link.onmouseout = () => { link.style.background = '#0057b8'; };
            // Link-Icon (SVG)
            const icon = document.createElement('span');
            icon.innerHTML = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 12.5L12.5 7.5M12 12H14.5C15.3284 12 16 11.3284 16 10.5V5.5C16 4.67157 15.3284 4 14.5 4H9.5C8.67157 4 8 4.67157 8 5.5V8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            link.textContent = 'Produktlink';
            link.appendChild(icon);
            infoCol.appendChild(link);
          }
          // Technische Daten
          if (json.technical_data) {
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.marginTop = '10px';
            table.style.borderCollapse = 'collapse';
            Object.entries(json.technical_data).forEach(([k, v]) => {
              if (k === 'Properties') return; // Skip Properties here
              const tr = document.createElement('tr');
              const tdKey = document.createElement('td');
              tdKey.textContent = k;
              tdKey.style.fontWeight = 'bold';
              tdKey.style.paddingRight = '16px';
              tdKey.style.paddingBottom = '6px';
              const tdVal = document.createElement('td');
              tdVal.textContent = v;
              tdVal.style.paddingBottom = '6px';
              tr.appendChild(tdKey);
              tr.appendChild(tdVal);
              table.appendChild(tr);
            });
            infoCol.appendChild(table);

            // Material Properties highlighted section (English)
            if (Array.isArray(json.technical_data.Properties) && json.technical_data.Properties.length > 0) {
              const propBox = document.createElement('div');
              propBox.style.background = '#f0f4f9';
              propBox.style.border = '1.5px solid #b3c6e0';
              propBox.style.borderRadius = '8px';
              propBox.style.padding = '14px 18px 10px 18px';
              propBox.style.marginTop = '18px';
              propBox.style.marginBottom = '6px';
              // Match width to technical data table
              propBox.style.maxWidth = '700px';
              propBox.style.width = 'min(100%, 700px)';

              const propTitle = document.createElement('div');
              propTitle.textContent = 'Material Properties';
              propTitle.style.fontWeight = 'bold';
              propTitle.style.fontSize = '1.1rem';
              propTitle.style.marginBottom = '8px';
              propBox.appendChild(propTitle);

              const propList = document.createElement('ul');
              propList.style.margin = '0';
              propList.style.padding = '0 0 0 18px';
              propList.style.listStyle = 'none';

              json.technical_data.Properties.forEach(p => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.alignItems = 'flex-start';
                li.style.gap = '8px';
                li.style.marginBottom = '4px';
                // Icon
                const icon = document.createElement('span');
                icon.innerHTML = `<svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 10.5L9 14.5L15 7.5" stroke="#0057b8" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                icon.style.marginTop = '2px';
                li.appendChild(icon);
                // Text
                const txt = document.createElement('span');
                txt.textContent = p.replace(/^- /, '').trim();
                li.appendChild(txt);
                propList.appendChild(li);
              });
              propBox.appendChild(propList);
              infoCol.appendChild(propBox);
            }
          }
          // Layout-Wrapper für Bild und Daten
          const contentRow = document.createElement('div');
          contentRow.style.display = 'flex';
          contentRow.style.flexDirection = 'row';
          contentRow.style.gap = '36px';
          contentRow.style.alignItems = 'flex-start';
          contentRow.style.justifyContent = 'flex-start';
          contentRow.style.width = '100%';
          contentRow.appendChild(img);
          contentRow.appendChild(errorMsg);
          contentRow.appendChild(infoCol);
          // Zusammenbauen
          inner.appendChild(titleDiv);
          inner.appendChild(contentRow);
          modal.innerHTML = '';
          modal.appendChild(inner);
        })
        .catch(() => {
          // Modal-Inhalt Wrapper (auch bei Fehler)
          const inner = document.createElement('div');
          inner.style.background = '#fff';
          inner.style.padding = '32px 32px 28px 32px';
          inner.style.borderRadius = '16px';
          inner.style.maxWidth = '950px';
          inner.style.width = '95vw';
          inner.style.maxHeight = '92vh';
          inner.style.overflowY = 'auto';
          inner.style.display = 'flex';
          inner.style.flexDirection = 'column';
          inner.style.alignItems = 'stretch';
          inner.style.boxShadow = '0 6px 32px rgba(0,0,0,0.18)';
          inner.onclick = (e) => { e.stopPropagation(); };
          // Titel
          const titleDiv = document.createElement('div');
          titleDiv.style.fontWeight = 'bold';
          titleDiv.style.fontSize = '2.1rem';
          titleDiv.style.marginBottom = '10px';
          titleDiv.style.display = 'flex';
          titleDiv.style.flexDirection = 'column';
          titleDiv.style.alignItems = 'flex-start';
          titleDiv.style.gap = '0';
          // Name + Farbe + Spool IDs
          let nameWithColor = '';
          if (row['Material']) {
            // Name fett und groß
            const nameDiv = document.createElement('div');
            nameDiv.style.fontWeight = 'bold';
            nameDiv.style.fontSize = '2.1rem';
            // Farbnamen
            let farbTextNode = document.createTextNode(row['Material'] + (farbeText ? ' ' + farbeText : ''));
            nameDiv.appendChild(farbTextNode);
            // Spool IDs dezent
            if (spoolIdString) {
              const idSpan = document.createElement('span');
              idSpan.textContent = spoolIdString;
              idSpan.style.fontSize = '1.3rem';
              idSpan.style.color = '#888';
              idSpan.style.marginLeft = '10px';
              idSpan.style.fontWeight = 'normal';
              nameDiv.appendChild(idSpan);
            }
            // Hersteller klein darunter
            const herstellerDiv = document.createElement('div');
            herstellerDiv.style.fontSize = '1.1rem';
            herstellerDiv.style.color = '#888';
            herstellerDiv.style.fontWeight = 'normal';
            herstellerDiv.style.marginTop = '2px';
            herstellerDiv.textContent = (row['Hersteller'] || row['Manufacturer'] || '');
            titleDiv.textContent = '';
            titleDiv.appendChild(nameDiv);
            titleDiv.appendChild(herstellerDiv);
          }
          // Layout-Wrapper für Bild und Daten
          const contentRow = document.createElement('div');
          contentRow.style.display = 'flex';
          contentRow.style.flexDirection = 'row';
          contentRow.style.gap = '36px';
          contentRow.style.alignItems = 'flex-start';
          contentRow.style.justifyContent = 'flex-start';
          contentRow.style.width = '100%';
          contentRow.appendChild(img);
          contentRow.appendChild(errorMsg);
          // Zusammenbauen
          inner.appendChild(titleDiv);
          inner.appendChild(contentRow);
          modal.innerHTML = '';
          modal.appendChild(inner);
        });
    }

    function isColumnFilterActive(key) {
      if (filters[key] && filters[key] !== '') return true;
      if (rangeFilters[key] && (
        rangeFilters[key].min.value != rangeFilters[key].min.min ||
        rangeFilters[key].max.value != rangeFilters[key].max.max
      )) return true;
      return false;
    }

    function getColumnFilterType(key) {
      if (key === 'Measured (g)' || key === 'Remaining (g)') return 'range';
      return 'dropdown';
    }

    // Hilfsfunktion für Farbinterpolation
    function interpolateColor(color1, color2, t) {
      // color1, color2: hex, t: 0..1
      function hexToRgb(hex) {
        hex = hex.replace('#', '');
        if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
        const num = parseInt(hex, 16);
        return [num >> 16, (num >> 8) & 255, num & 255];
      }
      function rgbToHex(r, g, b) {
        return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
      }
      const rgb1 = hexToRgb(color1);
      const rgb2 = hexToRgb(color2);
      const rgb = rgb1.map((c, i) => Math.round(c + (rgb2[i] - c) * t));
      return rgbToHex(rgb[0], rgb[1], rgb[2]);
    }

    // Hilfsfunktion: Versucht, einen CSS-Farbwert aus dem Text zu machen
    function getCssColor(val) {
      if (!val) return '#eee';
      if (colorNameMap[val.trim()]) return colorNameMap[val.trim()];
      // Hex oder rgb direkt verwenden
      if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(val.trim())) return val.trim();
      if (/^rgb\s*\(/i.test(val.trim())) return val.trim();
      // Standard-Farbnamen testen
      const s = document.createElement('span');
      s.style.color = val.trim();
      if (s.style.color) return val.trim();
      // RAL oder andere Codes: Grau
      return '#eee';
    }

    // Hilfsfunktion: CSS-Farbwert (auch Name) zu RGB-Array für jsPDF
    function cssColorToRgbArray(val) {
      // Hex
      if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(val)) {
        let hex = val.replace('#', '');
        if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
        const num = parseInt(hex, 16);
        return [num >> 16, (num >> 8) & 255, num & 255];
      }
      // rgb(x, y, z)
      if (/^rgb\s*\(/i.test(val)) {
        const m = val.match(/\d+/g);
        if (m && m.length >= 3) return [parseInt(m[0]), parseInt(m[1]), parseInt(m[2])];
      }
      // Farbnamen: temporäres Element nutzen
      const s = document.createElement('span');
      s.style.color = val;
      document.body.appendChild(s);
      const rgb = window.getComputedStyle(s).color;
      document.body.removeChild(s);
      const m = rgb.match(/\d+/g);
      if (m && m.length >= 3) return [parseInt(m[0]), parseInt(m[1]), parseInt(m[2])];
      // Fallback: hellgrau
      return [238,238,238];
    }

    // Data loading with loading spinner
    function loadData({ showLoader = true, showUpdatePopup = false } = {}) {
      if (showLoader) {
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('loaderText').textContent = 'Loading data from Google Sheets';
      }
      const controller = new AbortController();
      const timeout = setTimeout(() => {
        controller.abort();
        if (showLoader) document.getElementById('loaderText').textContent = 'Timeout while loading data from Google Sheets!';
      }, 12000);
      fetch(sheetUrl, { signal: controller.signal })
        .then(res => res.json())
        .then(data => {
          clearTimeout(timeout);
          if (showLoader) document.getElementById('loaderText').textContent = 'Processing data';
          // Vergleiche alte und neue Daten
          let changed = false;
          if (Array.isArray(originalData) && Array.isArray(data) && originalData.length === data.length) {
            for (let i = 0; i < data.length; i++) {
              const oldRow = originalData[i] || {};
              const newRow = data[i] || {};
              const keys = Object.keys(newRow);
              for (let k = 0; k < keys.length; k++) {
                const key = keys[k];
                if (oldRow[key] !== newRow[key]) {
                  changed = true;
                  break;
                }
              }
              if (changed) break;
            }
          } else if (originalData.length !== data.length) {
            changed = true;
          }
          originalData = data;
          renderTable(data);
          applyUrlFiltersAndLock();
          applyFilters();
          const keys = Object.keys(data[0]);
          if (keys.length > 0) {
            filters[keys[0]] = data[0][keys[0]];
            applyFilters();
            filters[keys[0]] = '';
            applyFilters();
          }
          if (showUpdatePopup && changed) {
            showDataUpdatePopup();
          }
          // Nach jedem Laden der Daten: Link-Manager-Modal schließen
          const linkManagerModal = document.getElementById('linkManagerModal');
          if (linkManagerModal) linkManagerModal.style.display = 'none';
        })
        .catch((err) => {
          clearTimeout(timeout);
          if (showLoader) {
            if (err.name === 'AbortError') {
              document.getElementById('loaderText').textContent = 'Timeout while loading data from Google Sheets!';
            } else {
              document.getElementById('loaderText').textContent = 'Error loading data from Google Sheets!';
            }
          }
        })
        .finally(() => {
          if (showLoader) {
            setTimeout(() => {
              document.getElementById('loader').style.display = 'none';
            }, 1200);
          }
        });
    }

    function showDataUpdatePopup() {
      const popup = document.getElementById('dataUpdatePopup');
      popup.style.display = 'block';
      popup.style.opacity = '1';
      setTimeout(() => {
        popup.style.opacity = '0';
        setTimeout(() => { popup.style.display = 'none'; }, 400);
      }, 4000);
    }

    // Initial load
    loadData({ showLoader: true });
    // Auto-refresh every 60 seconds (background, with popup if changed)
    setInterval(() => {
      loadData({ showLoader: false, showUpdatePopup: true });
    }, 60000);

    // PDF-Export Funktionalität
    document.getElementById('printBtn').onclick = function() {
      // Spool IDs aus der aktuell angezeigten Tabelle auslesen (vierte Spalte)
      const tableBody = document.querySelector('#spoolTable tbody');
      const visibleSpoolIds = new Set();
      Array.from(tableBody.querySelectorAll('tr')).forEach(tr => {
        const cells = tr.querySelectorAll('td');
        if (cells.length >= 4) {
          visibleSpoolIds.add(cells[3].textContent.trim());
        }
      });
      // Modal anzeigen
      const modal = document.getElementById('printModal');
      const rowsDiv = document.getElementById('printRows');
      rowsDiv.innerHTML = '';
      // Zeilen holen: IMMER alle Zeilen mit Spool ID anzeigen, unabhängig von Filtern
      const filtered = originalData.filter(row => row['Spool ID'] && row['Spool ID'].trim() !== '');
      // Checkboxen für jede Zeile mit Spool ID
      filtered.forEach((row, idx) => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '12px';
        // Bildvorschau
        const material = (row['Material'] || '').replace(/ /g, '%20');
        const hersteller = (row['Hersteller'] || row['Manufacturer'] || '').replace(/ /g, '%20');
        const farbe = (row['Farbe'] || row['Color'] || '').replace(/ /g, '%20');
        const imgUrl = `https://raw.githubusercontent.com/hoedii/Filament-Storage/main/ressourcen/${material}_${hersteller}_${farbe}.jpg`;
        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = 'Filament';
        img.style.width = '38px';
        img.style.height = '38px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '7px';
        img.style.background = '#f6f6f6';
        img.style.border = '1px solid #ddd';
        img.onerror = () => { img.style.display = 'none'; };
        label.appendChild(img);
        // Checkbox
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        // Haken nur, wenn Spool ID in der Tabelle sichtbar ist
        cb.checked = visibleSpoolIds.has((row['Spool ID'] || '').trim());
        cb.value = idx;
        cb.onclick = (e) => e.stopPropagation();
        label.appendChild(cb);
        // Zeilen-Text (z.B. Spool ID + Material + Farbe)
        let txt = row['Spool ID'] || '';
        if (row['Material']) txt += ' | ' + row['Material'];
        if (row['Farbe'] || row['Color']) txt += ' | ' + (row['Farbe'] || row['Color']);
        label.appendChild(document.createTextNode(txt));
        rowsDiv.appendChild(label);
      });
      modal.style.display = 'flex';
    };
    document.getElementById('printCancel').onclick = function() {
      document.getElementById('printModal').style.display = 'none';
    };
    document.getElementById('printForm').onsubmit = function(e) {
      e.preventDefault();
      const modal = document.getElementById('printModal');
      const checkboxes = Array.from(document.querySelectorAll('#printRows input[type=checkbox]'));
      const selectedIdx = checkboxes.filter(cb => cb.checked).map(cb => parseInt(cb.value));
      if (selectedIdx.length === 0) {
        alert('Please select at least one position!');
        return;
      }
      // Zeilen für PDF: gleiche Reihenfolge wie im Modal (alle mit Spool ID)
      const filtered = originalData.filter(row => row['Spool ID'] && row['Spool ID'].trim() !== '');
      const rows = selectedIdx.map(i => filtered[i]);
      // PDF erzeugen (Querformat)
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait' });
      if (!rows.length) return;
      const keys = Object.keys(rows[0]);
      // Spalten-Definitionen für Optik
      const head = [keys.map(k => k)];
      const body = rows.map(row => keys.map(k => {
        // Checkboxen als x für Full, Empty, Refill
        if ((k === 'Full' || k === 'Empty' || k === 'Refill') && row[k] === 'x') return 'x';
        // Checkboxen als Häkchen (sonstige)
        if (row[k] === 'x') return '✔️';
        // Zahlen rechtsbündig, g-Einheit
        if (!isNaN(row[k]) && row[k] !== '') {
          if (k === 'Measured (g)') {
            return parseFloat(row[k]).toFixed(1) + ' g';
          }
          if (k === 'Remaining (g)') {
            const val = parseFloat(row[k]);
            if (val === 1000.0) return '1000 g';
            return val.toFixed(1) + ' g';
          }
          return row[k];
        }
        // Color/Farbe-Spalte: Nur Farbnamen zurückgeben
        if (k === 'Farbe' || k === 'Color') {
          const colorVal = (row[k] || '').trim();
          return colorVal;
        }
        return row[k] || '';
      }));
      // Spaltenausrichtung: Checkboxen/Farbe/Strings links, Zahlen rechts
      const columnStyles = {};
      keys.forEach((k, i) => {
        if (k === 'Farbe' || k === 'Color') {
          columnStyles[i] = { halign: 'left', cellWidth: 24 };
        } else {
          columnStyles[i] = { halign: (!isNaN(rows[0][k]) ? 'right' : 'left'), cellWidth: 'auto' };
        }
        if (k === 'Full' || k === 'Empty' || k === 'Refill') columnStyles[i].halign = 'center';
      });
      // Summenoptionen auslesen
      const showTotalFilament = document.getElementById('pdfTotalFilament').checked;
      const showTotalResin = document.getElementById('pdfTotalResin').checked;
      const showTotalAll = document.getElementById('pdfTotalAll').checked;
      // Summen berechnen
      let filament = 0, resin = 0;
      rows.forEach(row => {
        const mat = (row["Material"] || "").toLowerCase();
        const val = parseFloat(row["Remaining (g)"]);
        if (!isNaN(val)) {
          if (mat.includes("resin")) resin += val;
          else filament += val;
        }
      });
      const total = filament + resin;

      // Summenzeilen vorbereiten
      const summaryRows = [];
      if (showTotalFilament) summaryRows.push(["Total Filament", (filament/1000).toFixed(2) + " kg"]);
      if (showTotalResin) summaryRows.push(["Total Resin", (resin/1000).toFixed(2) + " kg"]);
      if (showTotalAll) summaryRows.push(["Total", (total/1000).toFixed(2) + " kg"]);

      // PDF-Tabelle
      doc.autoTable({
        head: head,
        body: body,
        styles: { fontSize: 7, cellPadding: {top: 1, bottom: 1, left: 2, right: 2} },
        headStyles: { fillColor: [248, 249, 250], textColor: 34, fontStyle: 'bold' },
        columnStyles: columnStyles,
        margin: { top: 12, left: 8, right: 8 },
        theme: 'grid',
        didParseCell: function(data) {
          const colKey = keys[data.column.index];
          if ((colKey === 'Farbe' || colKey === 'Color') && data.cell.section === 'body') {
            data.cell.text = [''];
          }
        },
        willDrawCell: function(data) {
          const colKey = keys[data.column.index];
          // Remaining (g) farblich wie im Web als Hintergrund
          if (colKey === 'Remaining (g)' && data.section === 'body') {
            let val = rows[data.row.index][colKey];
            val = parseFloat(val);
            let bgColor = null;
            if (val === 0) {
              bgColor = null;
            } else if (val >= 1000) {
              bgColor = [224,224,224];
            } else if (val > 500) {
              const t = (val - 500) / 500;
              const r = Math.round(255 + (76-255)*t);
              const g = Math.round(235 + (175-235)*t);
              const b = Math.round(59 + (80-59)*t);
              bgColor = [r,g,b];
            } else {
              const t = val / 500;
              const r = Math.round(244 + (255-244)*t);
              const g = Math.round(67 + (235-67)*t);
              const b = Math.round(54 + (59-54)*t);
              bgColor = [r,g,b];
            }
            if (bgColor) {
              const { x, y, width, height } = data.cell;
              if (typeof doc.setGState === 'function' && typeof doc.GState === 'function') {
                doc.setGState(new doc.GState({ opacity: 0.6 }));
                doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
                doc.roundedRect(x + 0.5, y + 0.5, width - 1, height - 1, 2, 2, 'F');
                doc.setGState(new doc.GState({ opacity: 1 }));
              } else {
                doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
                doc.roundedRect(x + 0.5, y + 0.5, width - 1, height - 1, 2, 2, 'F');
              }
            }
          }
        },
        didDrawCell: function(data) {
          const colKey = keys[data.column.index];
          // Textfarbe für Spool ID explizit setzen
          if (colKey === 'Spool ID' && data.cell.section === 'body') {
            doc.setTextColor(80,80,80);
          }
          // Textfarbe für Remaining (g) ggf. anpassen
          if (colKey === 'Remaining (g)' && data.cell.section === 'body') {
            let val = rows[data.row.index][colKey];
            val = parseFloat(val);
            let textColor = [34,34,34];
            if (val === 0) {
              textColor = [136,136,136];
            } else if (val >= 1000) {
              textColor = [51,51,51];
            }
            doc.setTextColor(textColor[0], textColor[1], textColor[2]);
          }
          if ((colKey === 'Farbe' || colKey === 'Color') && data.cell.section === 'body') {
            // Farbfeld-Quadrat und Text in Color/Farbe-Spalte zeichnen
            const colorVal = data.cell.raw;
            const x = data.cell.x;
            const y = data.cell.y;
            const height = data.cell.height;
            const size = Math.min(4, height - 2);
            const textOffset = 2;
            // Farbe bestimmen
            let cssColor = '#eee';
            if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(colorVal)) cssColor = colorVal;
            else if (typeof getCssColor === 'function') cssColor = getCssColor(colorVal);
            const rgb = cssColorToRgbArray(cssColor);
            // Quadrat zeichnen
            const rx = x + 2;
            const ry = y + (height - size) / 2;
            const r = 0.8;
            doc.setFillColor(rgb[0], rgb[1], rgb[2]);
            doc.roundedRect(rx, ry, size, size, r, r, 'F');
            if (rgb[0] === 255 && rgb[1] === 255 && rgb[2] === 255) {
              doc.setLineWidth(0.1);
              doc.setDrawColor(0,0,0);
              doc.roundedRect(rx, ry, size, size, r, r, 'S');
            }
            doc.setFillColor(255,255,255);
            // Text daneben in exakt gleicher Farbe wie Spool ID
            doc.setTextColor(80,80,80);
            doc.setFontSize(7);
            doc.text(String(colorVal), x + 2 + size + textOffset, y + height / 2, { baseline: 'middle' });
            data.cell.text = [''];
          }
          // Summenzeilen am Ende einfügen
          if (data.row.index === rows.length - 1 && summaryRows.length > 0 && data.cell.section === 'body' && data.column.index === keys.length - 1) {
            let y = data.cell.y + data.cell.height;
            summaryRows.forEach(([label, val]) => {
              doc.setFontSize(7);
              doc.setFont(undefined, 'bold');
              doc.setTextColor(80,80,80);
              doc.text(`${label}: ${val}`, data.cell.x + data.cell.width, y + 7, { align: 'right' });
              y += 7;
            });
            doc.setFont(undefined, 'normal');
          }
        }
      });
      // Footer-Text und Datum unten auf der Seite
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const footerText = '© 2025 piodeer. All rights reserved. Created with Github, Cursor & ChatGPT.';
      const d = new Date();
      const dateText = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth()+1).padStart(2, '0')}.${d.getFullYear()}`;
      doc.setFontSize(7);
      doc.setTextColor(180,180,180);
      doc.text(footerText, pageWidth / 2, pageHeight - 10, { align: 'center' });
      doc.text(dateText, pageWidth / 2, pageHeight - 4, { align: 'center' });
      
      const fileDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      doc.save(`Filament Storage ${fileDate}.pdf`);
      modal.style.display = 'none';
    };

    // Globaler Klick-Listener zum Schließen des Filter-Popups beim Klick außerhalb
    if (!window._popupOutsideClickListenerAdded) {
      document.addEventListener('mousedown', function(event) {
        document.querySelectorAll('.filter-popup[style*="display: block"]').forEach(openPopup => {
          if (!openPopup.contains(event.target)) {
            if (typeof openPopup._applyTempFilterAndClose === 'function') {
              openPopup._applyTempFilterAndClose();
            } else {
              openPopup.style.display = 'none';
            }
          }
        });
      });
      window._popupOutsideClickListenerAdded = true;
    }

    // Beim Schließen des Popups min-height zurücksetzen
    function resetCardMinHeight() {
      const card = document.querySelector('.card');
      const table = document.getElementById('spoolTable');
      if (card) card.style.minHeight = '';
      if (table) table.style.minHeight = '';
    }

    // Stelle sicher, dass das Link-Manager-Modal beim Laden der Seite geschlossen ist
    document.addEventListener('DOMContentLoaded', function() {
      const linkManagerModal = document.getElementById('linkManagerModal');
      if (linkManagerModal) linkManagerModal.style.display = 'none';
    });

    // Enable closing printModal and createLinkModal by clicking outside the modal content
    function setupModalOverlayClose(modalId, formId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.addEventListener('mousedown', function(e) {
        // Only close if click is directly on the overlay, not inside the form
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      setupModalOverlayClose('printModal', 'printForm');
      setupModalOverlayClose('createLinkModal', 'createLinkForm');
      setupModalOverlayClose('linkManagerModal');
    });

    // Allow closing linkManagerModal by clicking outside the modal content
    function setupModalOverlayClose(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.addEventListener('mousedown', function(e) {
        // Only close if click is directly on the overlay, not inside the content
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
